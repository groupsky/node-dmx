name: Release

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release and update changelog'
        required: true
        type: boolean
        default: true
      publish_npm:
        description: 'Publish to npm registry'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: inputs.create_release
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}

    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: node

      - name: Release summary
        if: steps.release.outputs.release_created
        run: |
          echo "### Release Created :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL:** ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to npm
    needs: release
    if: inputs.publish_npm && needs.release.outputs.release_created
    runs-on: ubuntu-latest
    environment: npm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.release.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          registry-url: 'https://registry.npmjs.org'

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@acb598e5ddbc6f68a970c5da0688d2f3a9f04d05 # v1.6.0
        with:
          packages: libftdi-dev libftdi1
          version: 1.0

      - name: Install dependencies and build
        run: npm install

      - name: Verify build output
        run: |
          test -f dmx_native.node
          echo "Build successful for version ${{ needs.release.outputs.version }}"

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish summary
        run: |
          echo "### Published to npm :package:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** dmx@${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** https://www.npmjs.com/package/dmx" >> $GITHUB_STEP_SUMMARY
